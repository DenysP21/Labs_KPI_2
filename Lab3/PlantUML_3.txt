@startuml
autonumber

actor Member
actor Librarian
participant "Library system" as LS
participant "Loan service" as LoS
participant "Member service" as MS
database "Loan/Member DB" as LDB
database "Book DB" as BDB

Member -> Librarian: requestBookLoan(userID, bookID)
activate Librarian
Librarian -> LS: enterReaderAndBookData(userID, bookID)
activate LS
LS -> LoS: processLoanRequest(userID, bookID)
activate LoS
LoS -> MS: readerService.checkStatus(userID)
activate MS
MS -> LDB: getReaderData(userID)
activate LDB
deactivate LDB

alt Status UNAVAILABLE
    MS -> LoS: Status UNAVAILABLE
    deactivate MS
    LoS -> LS: 6.1 LoanResult REJECTED
    LoS -> LS: rejectLoan(reason)
    deactivate LoS
    LS -> Librarian: 7. rejectLoan(reason)
    Librarian -> Member: displayRejectionReason(reason)
    Member -> Member: notifyReader(message)
    deactivate LS
else Status AVAILABLE
    MS -> LoS: 6.2 Status AVAILABLE
    deactivate MS
    LoS -> BDB: bookDB.checkAvailability(bookID)
    activate BDB
    BDB -> LoS: 11 Status AVAILABLE
    deactivate BDB
    LoS -> LDB: loanDB.createLoanRecord(userDetails)
    activate LDB
    LoS -> LDB: loanDB.createLoanRecord(loanID)
    deactivate LDB
    LoS -> BDB: bookService.updateStatus(bookCopyID, Status_ON_LOAN)
    activate BDB
    BDB -> LoS: 15 Status UPDATED
    deactivate BDB
    LoS -> LS: recordLoanSuccessful(loanID)
    deactivate LoS
    LS -> Librarian: loanConfirmation
    deactivate LS
    Librarian -> Member: handOverBook(book)
    deactivate Librarian
end

@enduml